#!/usr/sbin/nft -f

flush ruleset

table inet firewall {
  chain input {
    type filter hook input priority 0;

    # Default policy
    policy drop;

    # Allow loopback interface
    iif "lo" accept

    # Drop invalid packets
    ct state invalid drop

    # Accept established/related connections
    ct state established,related accept

    # Allow SSH on custom port 2025
    tcp dport 2025 ct state new,established accept

    # (Optional) Rate-limit SSH brute force attempts
    ip protocol tcp tcp dport 2025 ct state new limit rate 6/minute accept

    # Allow HTTP
    tcp dport 80 ct state new,established accept

    # Allow HTTPS
    tcp dport 443 ct state new,established accept

    # Allow outgoing SMTP (Submission)
    tcp sport 587 ct state established accept
    tcp dport 587 ct state new,established accept

    # Allow IMAPS
    tcp dport 993 ct state new,established accept

    # Log and drop everything else (optional for auditing)
    log prefix "nftables: denied: " flags all counter drop
  }

  chain forward {
    type filter hook forward priority 0;
    policy drop;
  }

  chain output {
    type filter hook output priority 0;

    # Default policy
    policy drop;

    # Allow loopback output
    oif "lo" accept

    # Allow established/related outbound
    ct state established,related accept

    # Allow outbound connections for necessary ports
    tcp dport { 80, 443, 587, 993 } ct state new,established accept

    # Allow outbound SSH replies
    tcp sport 2025 ct state established accept
  }
}
